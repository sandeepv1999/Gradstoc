name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2key
          chmod 600 ~/.ssh/ec2key

      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2key \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH Connected!'"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2key \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

              # Use Node 18
              nvm install 18
              nvm use 18

              APP_DIR="/home/ubuntu/gradstoc"

              # Create folder if not exists
              mkdir -p $APP_DIR
              cd $APP_DIR

              if [ -d ".git" ]; then
                echo "ðŸ”„ Repo exists â€” pulling latest changes"
                git fetch origin
                git reset --hard origin/main
              else
                echo "â¬‡ Cloning repository first time"
                git clone https://github.com/${GITHUB_REPOSITORY}.git .
              fi

              echo "ðŸ“¦ Installing dependencies..."
              npm install --force

              echo "ðŸš€ Restarting PM2"
              if pm2 list | grep -q "gradstoc"; then
                pm2 restart gradstoc --update-env
              else
                pm2 start app.js --name "gradstoc"
              fi

              pm2 save

          EOF
