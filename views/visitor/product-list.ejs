<%- include('../header') %>

    <body class="home">
        <div class="main-wrapper">
            <section class="section-middle">
                <div class="page-title">
                    <div class="container">
                        <div class="page-title-in">
                            <h2>
                                <%- type==0 ? 'Book' : 'Document' %>
                            </h2>
                        </div>
                    </div>
                </div>
                <!--page-title-->

                <div class="container">
                    <div class="product-page-section">
                        <div class="row">

                            <div class="col-md-3 " style="max-height: 500px;">
                                <div class="product-page-aside">
                                    <form method="get" action="/product">
                                        <div class="form-group mt-1">
                                            <input type="text" class="form-control" id="search" name="search" value=""
                                                placeholder="Search..." />
                                            <input type="hidden" class="form-control" name="type" value="<%- type%>" />
                                        </div>
                                        <div class="form-group">
                                            <label>School</label>
                                            <select class="form-control" id="school" name="school">
                                                <option value="" selected="">
                                                    Select school</option>
                                                <% for(let key of school) { %>
                                                    <option value="<%- key._id  %>">
                                                        <%- key.name %>
                                                    </option>
                                                    <% } %>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Subject</label>
                                            <select class="form-control" id="subject" name="subject">
                                                <option value="">Select subject
                                                </option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Price Range</label>
                                            <input style="width: 220px;margin-left: 8px;" class="price-range"
                                                type="range" id="price_range" name="price_range" value="0" min="0"
                                                max="1000" onInput="$('#rangeval').html($(this).val())">
                                            <label id="rangeval">0</label>
                                        </div>
                                        <div class="form-group">
                                            <label>Tag</label>
                                            <select class="form-control" id="tag" name="tag">
                                                <option value="">
                                                    Select tag
                                                </option>
                                                <% for (let tag of tags) { %>
                                                    <option value="<%- tag._id %>">
                                                        <%- tag.name %>
                                                    </option>
                                                    <% } %>
                                            </select>
                                        </div>
                                       
                                        <button style="margin-left:100px" type="submit"
                                            class="btn btn-primary">Search</button> &nbsp;
                                        <button id="reset_form" class="btn btn-default bg-primary" type="button">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <% if(bookData.length==0 ) {%>
                                    <div class="aalert alert-success" style="padding: 12px;" align="center"
                                        id="alertmsg">
                                        <strong>No Record Found</strong>
                                    </div>
                                    <% } else { %>
                                        <div class="product-page-main">
                                            <div class="product-page-top">
                                                <% if(bookData.length> 0 ) {%>
                                                    <div class="total-item"> Uploads : <%- skip+1 %> - <%-
                                                                bookCount%limit !==0 && currentPage==totalPages ?
                                                                remaining : limit * currentPage%>
                                                                of <%- bookCount %>
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <div class="product-page-items">
                                                <ul>
                                                    <% for(let book of bookData) { %>
                                                        <% let avg ,rat, sum = 0; %>
                                                        <% if( book.reviews.length > 0) { %>
                                                            <% for(let i = 0; i < book.reviews.length; i++ ) { %>
                                                            <%  sum  +=  book.reviews[i].rating ;
                                                                avg  = Math.round(parseFloat(sum/book.reviews.length))%>    
                                                            <% } %>
                                                              <% rat = 1 %>      
                                                            <% } else { %>
                                                                <% rat = 0 %>
                                                                <% }  %>

                                                            <!-- if book already purchased  -->

                                                                <% let allreadyPurchased = 0 %>
                                                                <% for(let i = 0; i< soldProduct.length; i++){ %>
                                                                    <% if(book._id.toString() == soldProduct[i].product_id.toString() ) { %>
                                                                         <% allreadyPurchased = 1%>        
                                                                    <% }  %>
                                                                <% } %> 

                                                        <li>
                                                            <div class="materials-item">
                                                                <div class="materials-item-inn card">
                                                                    <div class="materials-item-img card-img">
                                                                        <a
                                                                            href="/product-detail?productId=<%-book._id%>&avg=<%- avg %>purchase=<%- allreadyPurchased%>"><img
                                                                                src="uploads/<%- book.image %>"
                                                                                alt=""></a>
                                                                    </div>
                                                                    <div class="materials-item-cont card-body">
                                                                        <div class="materials-item-name card-title">
                                                                            <a href="#">
                                                                                <%= book.title.length> 15 ?
                                                                                    book.title.substring(0, 15)
                                                                                    +'..':book.title
                                                                                %>
                                                                            </a>
                                                                        </div>
                                                                        <div class="materials-rt-ct">
                                                                            <div class="materials-price-rt">
                                                                                <div class="materials-price">
                                                                                    <%- book.price %>
                                                                                </div>

                                                                                    <% if(rat == 1) { %>
                                                                                                <div class="reviews-stars" style="font-size:small;">
                                                                                                <% for (let x=0 ; x < avg; x++) { %>
                                                                                                    <i class="fas fa-star" style="color:#FF912C;;"></i>
                                                                                                    <% } %>
                                                                                                        <% for (let y=avg ;y < 5;y++) { %>
                                                                                                            <i class="fas fa-star"></i>
                                                                                                            <% } %>
                                                                                            </div>
                                                                                        <% } else { %>
                                                                                            <div class="reviews-stars" style="font-size:small;">
                                                                                                <i class="fas fa-star"></i>
                                                                                                <i class="fas fa-star"></i>
                                                                                                <i class="fas fa-star"></i>
                                                                                                <i class="fas fa-star"></i>
                                                                                                <i class="fas fa-star"></i>
                                                                                            </div>
                                                                                            <% }  %>
                                                                            </div>
                                                                            <div class="materials-cart">
                                                                    


                                                                                <% if(cartItems.length > 0) {  %>
                                                                                        <% if(cartItems.includes(book._id.toString())) { %> 
                                                                                             <a href="/my-cart" ><i
                                                                                        class="fas fa-eye"></i></a>
                                                                                        <% } else if(allreadyPurchased == 1){ %>          <!-- user allready purchased -->
                                                                                            <a href="uploads/<%- book.main_file %>" download="main file"><i 
                                                                                                class="fas fa-download "></i></a>
                                                                                        <% } else { %>
                                                                                            <a href="#"
                                                                                            onclick="addToCart('<%- book._id %>')"><i id="cart"
                                                                                                class="fas fa-shopping-cart "></i></a>
                                                                                            <%  } %> 
                                                                                    <% } else { %>
                                                                                        <% if(allreadyPurchased == 1) { %>
                                                                                            <a href="uploads/<%- book.main_file %>" download="main file"><i 
                                                                                                class="fas fa-download "></i></a>
                                                                                            <%  } else { %>
                                                                                        <a href="#"
                                                                                        onclick="addToCart('<%- book._id %>')"><i id="cart"
                                                                                            class="fas fa-shopping-cart "></i></a>
                                                                                            <% } %>
                                                                                    <% } %>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </li>
                                                        <% } %>
                                                </ul>
                                            </div>
                                            <div class="item-pagination">
                                                <ul class="pagination">
                                                    <% for(let i=1; i <=totalPages; i++) { %>
                                                        <% if(i==1) { %>
                                                            <li class="page-item"><a class="page-link"
                                                                    href="?page=<%- i %>&search=<%- search %>&school=<%- search_school %>&subject=<%- subject %>&price_range=<%- price_range %>&tag=<%- tag %>&type=<%- type %>"><i
                                                                        class="fas fa-chevron-left"></i></a>
                                                            </li>
                                                            <% } %>
                                                                <li
                                                                    class="page-item <%= (currentPage==i)? 'active': ''; %>">
                                                                    <a class="page-link" href="?page=<%- i %>&search=<%- search %>&school=<%- search_school %>&subject=<%- subject %>&price_range=<%- price_range %>&tag=<%- tag %>&type=<%- type %>">
                                                                        <%- i %>
                                                                    </a>
                                                                </li>
                                                                <% if(i==totalPages) { %>

                                                                    <li class="page-item"><a class="page-link"
                                                                            href="?page=<%- totalPages %>&search=<%- search %>&school=<%- search_school %>&subject=<%- subject %>&price_range=<%- price_range %>&tag=<%- tag %>&type=<%- type %>">
                                                                            <i class="fas fa-chevron-right"></i></a>
                                                                    </li>
                                                                    <% } %>
                                                                <% } %>
                                                </ul>
                                            </div>
                                        </div>
                                    <% } %>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="modal fade" id="cart_modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-sign-div">
                                <button type="button" class="close" id="closePopup"
                                    data-dismiss="modal">&times;</button>
                                <div class="modal-sign-in">
                                    <div class="modal-sign-body modal-post-body">
                                        <div class="aalert alert-success" style="padding: 12px;" align="center"
                                            id="alertmsg">
                                            <strong>This item successfully added in your cart !!</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </section>
            <!--section-middle-->
            <%- include('../popup') %>
        </div>
        <%- include('../footer') %>


            <script src="js/index.js" type="text/jscript"></script>
            <!---------slider Js------------>
    </body>
    <script>
        // GET SUBJECT BY SCHOOL FOR BOOKS

        $('#school').change((e) => {
            let school_id = document.getElementById('school').value;
            $.ajax({
                type: 'GET',
                url: `/subject/?scl_id=${school_id}`,
                dataType: "json",
                success: function (data) {
                    console.log('dta', data);
                    let html = ''
                    if (data.success) {
                        html += `<option value="">
                            Select
                            Subject</option>`
                        $('#subject').html(html);
                        for (let sub of data.scl_sub) {
                            html += `<option value="${sub._id}">${sub.name}</option>`;
                            $('#subject').html(html);

                        }
                    } else {
                        // html += `<option value="">Select Subject</option>`;
                        $('#subject').html(html);
                    }
                }
            });
        });

        $('#reset_form').click(() => {
            $('#school').val('');
            $('#subject').val('');
            $('#search').val('');
            location.replace('http://localhost:3300/product?type=<%- type %>')
        });


        // Add to cart 

        function addToCart(productId) {
            $.ajax({
                type: 'GET',
                url: `/cart/${productId}`,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        $('#cart').addClass("fa-eye");
                        $('#cart').removeClass("fa-shopping-cart");
                        location.replace('http://localhost:3300/product?type=<%- type %>');
                    }
                }
            })
        }

    </script>