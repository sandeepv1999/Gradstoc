<%- include('../header'); %>

    <body class="home">
        <div class="main-wrapper">
            <section class="section-middle">
                <div class="page-title">
                    <div class="container">
                        <div class="page-title-in">
                            <h2>Tutor My Uploads</h2>
                        </div>
                    </div>
                </div><!-- page-title -->

                <div class="dashboard-content">
                    <div class="container">
                        <div class="row">
                            <%- include('sidebar'); %>

                                <div class="col-md-9">
                                    <div class="uploads-right-area">
                                        <div class="uploads-right-top">
                                            <div class="row">
                                                <div class="col-md-9">
                                                    <form method="get" action="/my-uploaded-products" id="search_book">
                                                        <div class="uploads-top-left">
                                                            <span class="date-picker">
                                                                <input type="date" class="form-control" id="start_date"
                                                                    name="start_date" value="" />
                                                            </span>
                                                            <span class="date-picker">
                                                                <input type="date" class="form-control" id="end_date"
                                                                    name="end_date" value="" />
                                                                <input type="hidden" class="form-control" id="type"
                                                                    name="type" value="<%- productType %>" />
                                                            </span>
                                                            <span class="select-picker">
                                                                <select class="form-control" id="search_school"
                                                                    name="search_school">
                                                                    <option value="" selected="">Select school</option>
                                                                    <% for(let key of schoolData) { %>
                                                                        <option value="<%- key._id%>">
                                                                            <%- key.name %>
                                                                        </option>
                                                                        <% } %>
                                                                </select>
                                                            </span>
                                                            <span>
                                                                <button type="submit" class="btn">Search</button>
                                                            </span>
                                                        </div>

                                                        <span id="search_school_err" style="color:red ;"></span>
                                                        <span id="start_date_err" style="color:red ;"></span>
                                                        <span id="end_date_err" style="color:red ;"></span>
                                                    </form>
                                                </div>
                                                <div class="col-md-1">
                                                    <button id="reset_form" class="btn btn-default" type="button">
                                                        <i class="fas fa-redo"></i>
                                                    </button>
                                                </div>

                                                <div class="col-md-2">
                                                    <div class="uploads-top-right">
                                                        <a href="/add-new-product?type=<%- productType %>"
                                                            class="btn"><i class="fas fa-plus-circle"></i> Add New <%-
                                                                productType==0 ? 'Book' : 'document ' %></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uploads-right-main">
                                            <div class="uploads-right-main-top">
                                                <div class="row">
                                                    <div class="col-md-5">
                                                        <% if(bookData.length> 0 ) {%>
                                                            <div class="up-ct">Uploads : <%- skip+1 %> - <%-
                                                                        bookCount%limit !==0 && currentPage==totalPages
                                                                        ? remaining : limit * currentPage%> of <%-
                                                                            bookCount %>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <div class="earnings-right">
                                                            <% if(bookData.length> 0 ) {%>
                                                                <div class="earnings">Toral Earnings :
                                                                    <span>$240.00</span>
                                                                </div>
                                                                <% } %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% if(bookData.length==0 ) {%>
                                                <div class="aalert alert-success" style="padding: 12px;" align="center"
                                                    id="alertmsg">
                                                    <strong>No Record Found</strong>
                                                </div>
                                                <% } else { %>
                                                    <div class="uploads-right-main-items">
                                                        <% for (let book of bookData) { %>
                                                            <% let avg ,rat, sum = 0; %>
                                                            <% if( book.reviews.length > 0) { %>
                                                                <% for(let i = 0; i < book.reviews.length; i++ ) { %>
                                                                <%  sum  +=  book.reviews[i].rating ;
                                                                    avg  = Math.round(parseFloat(sum/book.reviews.length))%>    
                                                                <% } %>
                                                                  <% rat = 1 %>      
                                                                <% } else { %>
                                                                    <% rat = 0; %>
                                                                    <% }  %>
                                                            <div class="uploads-right-main-item box-sh card card-body">
                                                                <div class="row">
                                                                    <div class="col-md-2">
                                                                        <div class="uploads-item-img">
                                                                            <img src="/uploads/<%- book.image %>"
                                                                                alt="" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-8">
                                                                        <div class="uploads-item-cont">
                                                                            <div class="uploads-item-title">
                                                                                <%- book.title; %>
                                                                            </div>
                                                                            <div class="uploads-item-dtls">
                                                                                <div class="uploads-item-dtls-left">
                                                                                    <div class="uploads-item-price">$
                                                                                        <span>
                                                                                            <%- book.price %>
                                                                                        </span>
                                                                                    </div>
                                                                                    <% if(rat == 1) { %>
                                                                                        <div class="reviews-stars" style="font-size:small;">
                                                                                        <% for (let x=0 ; x < avg; x++) { %>
                                                                                            <i class="fas fa-star" style="color:#FF912C;;"></i>
                                                                                            <% } %>
                                                                                                <% for (let y=avg ;y < 5;y++) { %>
                                                                                                    <i class="fas fa-star"></i>
                                                                                                    <% } %>
                                                                                    </div>
                                                                                <% } else { %>
                                                                                    <div class="reviews-stars" style="font-size:small;">
                                                                                        <i class="fas fa-star"></i>
                                                                                        <i class="fas fa-star"></i>
                                                                                        <i class="fas fa-star"></i>
                                                                                        <i class="fas fa-star"></i>
                                                                                        <i class="fas fa-star"></i>
                                                                                    </div>
                                                                                    <% }  %>
                                                                                </div>
                                                                                <div class="uploads-item-dtls-right">
                                                                                    <p>10 Sales<br />
                                                                                        Date uploaded : <%-
                                                                                            JSON.stringify(book.createdAt).slice(1
                                                                                            ,
                                                                                            11).split('-').reverse().join('-');
                                                                                            %>
                                                                                    </p>
                                                                                </div>
                                                                            </div>
                                                                            <div class="uploads-item-tags">
                                                                                <label>Tags -</label>
                                                                                <p>
                                                                                    <% for(let tag of book.tags){ %>
                                                                                        <span>
                                                                                            <%- tag.name %>
                                                                                        </span>
                                                                                        <% } %>
                                                                                </p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-2">
                                                                        <div class="uploads-item-right">

                                                                            <div class="uploads-item-edit">
                                                                                <a href="#"
                                                                                    onclick="deleteProduct('<%- book._id %>')"
                                                                                    data-toggle="tooltip"><i
                                                                                        class="fas fa-trash-alt text text-danger"></i>
                                                                                </a>
                                                                                <a href="/edit-product?productId=<%- book._id%>&avg=<%- avg %>"
                                                                                    data-toggle="tooltip"><i
                                                                                        class="far fa-edit"></i>
                                                                                </a>
                                                                            </div>

                                                                            <div class="uploads-item-active-inactive">
                                                                                <label>
                                                                                    <% if(book.visiblity==1) { %>
                                                                                        <input type="checkbox"
                                                                                            id="<%- book._id %>"
                                                                                            onclick="changeVisiblity('<%- book._id%>')"
                                                                                            name="checkbox" value=""
                                                                                            checked />
                                                                                        <span><small></small></span>
                                                                                        <% } else { %>
                                                                                            <input type="checkbox"
                                                                                                id="<%- book._id %>"
                                                                                                onclick="changeVisiblity('<%- book._id%>')"
                                                                                                name="checkbox"
                                                                                                value="" />
                                                                                            <span><small></small></span>
                                                                                            <% } %>
                                                                                </label>
                                                                            </div>
                                                                            <div class="uploads-item-btn">
                                                                                <a href="/product-detail?productId=<%- book._id %>"
                                                                                    class="btn">More...</a>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <% } %>

                                                    </div>
                                                    <div class="item-pagination">
                                                        <ul class="pagination">
                                                            <% for(let i=1; i <=totalPages; i++) { %>
                                                                <% if(i==1) { %>
                                                                    <li class="page-item"><a class="page-link"
                                                                            href="?page=<%- i %>&start_date=<%- start_date %>&end_date=<%- end_date %>&search_school=<%- search_school %>&type=<%- productType %>"><i
                                                                                class="fas fa-chevron-left"></i></a>
                                                                    </li>
                                                                    <% } %>
                                                                        <li
                                                                            class="page-item <%= (currentPage==i)? 'active': ''; %>">
                                                                            <a class="page-link "
                                                                                href="?page=<%- i %>&start_date=<%- start_date %>&end_date=<%- end_date %>&search_school=<%- search_school %>&type=<%- productType %>">
                                                                                <%- i %>
                                                                            </a>
                                                                        </li>
                                                                        <% if(i==totalPages) { %>

                                                                            <li class="page-item"><a class="page-link"
                                                                                    href="?page=<%- totalPages %>&start_date=<%- start_date %>&end_date=<%- end_date %>&search_school=<%- search_school %>&type=<%- productType %>">
                                                                                    <i
                                                                                        class="fas fa-chevron-right"></i></a>
                                                                            </li>
                                                                            <% } %>
                                                                                <% } %>
                                                        </ul>
                                                    </div>
                                                <% } %>    
                                        </div>
                                    </div>
                                </div>
                                <!--col-md-9-->
                        </div>
                        <!--row-->
                    </div>
                    <!--container-->
                </div>
                <!--dashboard-content-->
            </section>
        </div>
        <%- include('../footer'); %>
    </body>

    <script>

        $('#search_book').submit((e) => {
            let start_date = $('#start_date').val();
            let end_date = $('#end_date').val();
            let school = $('#search_school').val();
            if(start_date == "" && end_date == "" &&  school== ""){
                return false;
            }
            if (start_date !== '' && end_date == '') {
                $('#end_date_err').html('Please select end date');
                return false;
            }
            if (end_date !== '' && start_date == '' ) {
                $('#end_date_err').html('');
                $('#start_date_err').html('Please select end date');
                return false;
            }
        });

        $('#reset_form').click(() => {
            $('#start_date').val('');
            $('#end_date').val('');
            $('#search_school').val('');
            location.replace('http://localhost:3300/my-uploaded-products?type=<%- productType%>')
        });

        // window.onload = () => {
        //     history.pushState(null, "", location.href.split("?")[0]);
        // };

        function changeVisiblity(bookId) {
            let show = document.getElementById(`${bookId}`).checked;
            let checkValue = document.getElementById(`${bookId}`).value;
            checkValue = show ? '1' : '0';
            $.ajax({
                type: 'POST',
                url: "/show-product",
                data: { checkValue, bookId },
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        console.log('Book status updated');
                    }
                }
            });
        }

        function deleteProduct(product_id) {
            $.ajax({
                type: 'POST',
                url: "/delete-product",
                data: { product_id },
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        location.reload(true);
                    }
                }
            });
        }



    </script>